**Other languages: [English](README.md), [中文](README_cn.md).**

# 2PT-PYTHON

2PT-PYTHON is a Python implementation of the Two-Phase Thermodynamics (2PT) Model for calculating absolute entropy. In addition to calculating entropy for pure substances, it estimates entropy for mixtures by accounting for molecular size, reducing errors caused by volume calculations based solely on mole fraction.

## Installation
2PT-PYTHON has been tested on Python versions 3.10.14 and 3.12.7. Other versions have not been tested, so please verify compatibility yourself. A CPU with at least 4 cores is required. The provided test files were generated using Gromacs 2023.2.

```shell
git clone https://github.com/zdworld/2pt-python.git
cd 2pt-python
conda install --yes --file requirements.txt
```

## Usage
The 2PT method can produce accurate absolute entropy estimates from approximately 20 ps of condensed phase trajectories or 200 ps of gas phase trajectories. The trajectory should be generated in an NVT ensemble; if generated in an NPT ensemble, the box dimensions from the last frame are used. The saving frequency should be high enough to capture all vibrational modes, typically with a 4 fs sampling interval (sufficient for the maximum frequency of about 4100 cm^-1, covering most vibrational modes). To ensure reliability, sample at least 5000 frames and check for sufficient autocorrelation function decay.

### Trajectory Preprocessing
Molecular dynamics trajectories should first be processed for periodic boundaries and have translational and rotational motion removed:

```shell
echo 0 | gmx trjconv -f prod.trr -s prod.tpr -o prod.pbc.trr -pbc mol
echo -e "0\n0\n" | gmx trjconv -f prod.pbc.trr -s prod.tpr -o prod.fit.trr -fit rot+trans
```

### Configuration File
Using a 40 ps, 10001-frame trajectory of an OPC3 water box as an example (generated by `./gmxTraj/opc3.tpr`): the program reads a `.yaml` configuration file with the following format:

```yaml
Input:
  topology: "./gmxTraj/opc3.tpr"
  trajectory: "./gmxTraj/opc3.trr"
  Temperature: 298.15

Output:
  vacf: "./test/w_vacf.csv"
  dos: "./test/w_dos.csv"
  report: "./test/w_thermo.csv"

Groups:
  group1:
    name: "water1"
    selection: "same residue as name OW and prop z >= 20"
    density: 33
    constraints: 3
    rotation_symmetry: 2
    isLiner: false
    isCalculated: true
  group2:
    name: "water2"
    selection: "same residue as name OW and prop z < 20"
    density: 33
    constraints: 3
    rotation_symmetry: 2
    isLiner: false
    isCalculated: false
```

The configuration file has three main sections:
- `Input`: Specifies input files, including the paths for the topology and trajectory files and the system’s average temperature.
- `Output`: Specifies output files. `vacf` is the mass-weighted velocity autocorrelation function, `dos` is the density of states, and `report` is the calculation results. Leave empty if not needed.
- `Groups`: Specifies grouping information. Each group (group1, group2...) is a dictionary. Each group must consist of identical molecules, with no overlap between groups, and the union of all groups must encompass all atoms. Each group includes:
  - `name`: Group name, included in the report.
  - `selection`: Selection expression using [MDAnalysis selection syntax](https://docs.mdanalysis.org/stable/documentation_pages/selections.html). Since the rotational component of velocity is calculated per molecule, the selection should always include the residues of selected atoms. Incorrect selection in large molecules with multiple residues could lead to errors.
  - `density`: Molecular number density of the group (nm^-1), used to estimate molar volume. The total number density is multiplied by a coefficient `K_deltaV`; if `K_deltaV` deviates significantly from 1, the density estimation is likely inaccurate, affecting mixtures more than pure substances.
  - `constraints`: The degrees of freedom constrained within each molecule in this group. For rigid water, this is 3. Constraints on `h-bonds` in simulations should be recorded here.
  - `rotation_symmetry`: Rotational symmetry number, determined by molecular point group; see [Molecular symmetry, rotational entropy, and elevated melting points](https://doi.org/10.1021/ie990588m).
  - `isLiner`: Indicates if the molecule is linear, which only has two rotational axes and a unique rotational partition function.
  - `isCalculated`: Indicates if the entropy of this group should be calculated. If `false`, this group is skipped, though its density data is used to calculate other groups’ volumes.

In the example configuration, all atoms are divided into two groups:
- `water1`: Water molecules with `OW` atom `z` coordinate greater than or equal to 20 Å, whose entropy is calculated.
- `water2`: Water molecules with `OW` atom `z` coordinate less than 20 Å, whose entropy is not calculated.

### Running
```shell
python3 2PT.py -c config.yaml
```

The runtime depends on system size. Output is displayed in the terminal, and the program consumes a significant amount of memory. As a reference, the acetone box in the test folder (5000 atoms, 100001 frames) consumes 4420 MiB for velocity decomposition, with peak memory usage 3-4 times higher.

For mixtures, the total system entropy should subtract the mixing entropy:

$$
S_{\text{total}} = \sum_{i=1}^{n}S_i - R \sum_{i=1}^{n} n_i \ln x_i
$$

where $x_i$ is the mole fraction of group $i$, $n_i$ is the mole count of group $i$, and $S_i$ is the entropy of group $i$.
